import{r as e,j as a,s,R as t,c as i}from"./supabaseClient-y7L7r4ir.js";import{e as n,s as l,a as r,p as c,F as o,c as m,g as d}from"./Registration-DD62beqZ.js";/* empty css            */import"./supabase-client-FID_-7ME.js";import"./index-3r6UxFjv.js";function h({onSuccess:t}){const[i,n]=e.useState(""),[l,r]=e.useState(!1);return a.jsx("div",{className:"auth-modal",children:a.jsxs("div",{className:"auth-card",children:[a.jsx("div",{className:"auth-logo",children:a.jsx("img",{src:"/assets/img/title.png",alt:"Muqawama 2026"})}),a.jsx("h2",{children:"Welcome to Muqawama 2026"}),a.jsx("p",{className:"auth-subtitle",children:"Sign in with your Google account to register your team and manage your registration."}),i&&a.jsx("p",{className:"auth-error",children:i}),a.jsx("div",{className:"auth-alternative",children:a.jsx("button",{type:"button",className:"auth-oauth-btn google-btn",onClick:async()=>{n(""),r(!0);try{const{data:e,error:a}=await s.auth.signInWithOAuth({provider:"google",options:{redirectTo:window.location.origin+"/muqawamah/2026/register/"}});if(a)throw a}catch(e){n(`Google sign-in failed: ${e.message}. Please contact support.`),r(!1)}},disabled:l,children:l?a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"spinner-small"})," Signing in..."]}):a.jsxs(a.Fragment,{children:[a.jsx("i",{className:"fab fa-google"})," Continue with Google"]})})}),a.jsxs("p",{className:"auth-note",children:[a.jsx("i",{className:"fas fa-info-circle"})," Your Google account will be used to authenticate and save your team registration."]})]})})}async function u(e,{maxWidth:a,maxHeight:s,quality:t=.82}={}){return e&&"string"==typeof e&&e.startsWith("data:image/")?new Promise((i,n)=>{const l=new Image;l.onerror=()=>n(new Error("Failed to load image for resizing")),l.onload=()=>{try{let{width:e,height:n}=l;const r=Math.min((a||e)/e,(s||n)/n,1);e=Math.floor(e*r),n=Math.floor(n*r);const c=document.createElement("canvas");c.width=e,c.height=n;const o=c.getContext("2d");o.imageSmoothingEnabled=!0,o.imageSmoothingQuality="high",o.drawImage(l,0,0,e,n),i(c.toDataURL("image/webp",t))}catch(e){n(e)}},l.src=e}):null}const p=e.createContext(null),g=()=>{const a=e.useContext(p);if(!a)throw new Error("useRegistration must be used within RegistrationProvider");return a},x=()=>[...["GK","CB","LB","RB","CM","LM","ST"].map((e,a)=>({id:`${e}-${a}`,name:"",age:"",aadhar_no:"",position:e,isSubstitute:!1,image:null,x:50,y:50})),...["SUB1","SUB2","SUB3","SUB4"].map((e,a)=>({id:`${e}-${a}`,name:"",age:"",aadhar_no:"",position:"SUB",isSubstitute:!0,image:null,x:10+20*a,y:90}))],f={teamName:"",category:"open-age",teamLogo:null,teamLogoFileName:null,captainName:"",captainEmail:"",captainPhone:"",formation:"1-3-2-1"},j=({children:t})=>{const[i,r]=e.useState(1),[c,o]=e.useState(f),[m,d]=e.useState(x()),[h,g]=e.useState(!1),[j,N]=e.useState(!1),[y,v]=e.useState(null),[b,w]=e.useState(null),[S,_]=e.useState(null),[P,C]=e.useState(!1),[k,q]=e.useState(null),[L,T]=e.useState(null),[E,F]=e.useState(0),M=()=>{o(f),d(x()),w(null),_(null),q(null),T(null),F(0),r(1)},R=e.useCallback(async e=>{N(!0),v(null);try{const{data:{user:a}}=await s.auth.getUser();if(!a)throw new Error("You must be logged in to save your progress.");let t=S;const i={user_id:a.id,team_name:c.teamName||"Draft Team",category:c.category,team_logo:null,captain_name:c.captainName,captain_email:c.captainEmail||a.email,captain_phone:c.captainPhone,formation:c.formation,status:"submitted",last_saved_step:e,submitted_at:(new Date).toISOString()};if(S){const{error:e}=await s.from("team_registrations").update(i).eq("id",S);if(e)throw e}else{const{data:e,error:a}=await s.from("team_registrations").insert(i).select().single();if(a)throw a;t=e.id,_(t)}if(t){const e=await n({value:c.teamLogo,path:`registrations/${t}/team_logo.webp`}),a=await u(c.teamLogo,{maxWidth:240,maxHeight:240,quality:.82});if(await n({value:a,path:`registrations/${t}/team_logo_thumb.webp`}),e){o(a=>({...a,teamLogo:e}));const{error:a}=await s.from("team_registrations").update({team_logo:e}).eq("id",t);if(a)throw a}}const r=m.filter(e=>e.name&&""!==e.name.trim());if(r.length>0&&t){await s.from("team_players").delete().eq("team_id",t);const e=await Promise.all(r.map(async e=>{const a=l(e.id||e.name||"player"),s=await u(e.image||null,{maxWidth:240,maxHeight:240,quality:.82}),i=await u(e.image||null,{maxWidth:520,maxHeight:650,quality:.86});await n({value:s,path:`registrations/${t}/players/${a}_thumb.webp`}),await n({value:i,path:`registrations/${t}/players/${a}_card.webp`});const r=await n({value:e.image||null,path:`registrations/${t}/players/${a}.webp`});return{team_id:t,player_name:e.name,player_age:e.age?parseInt(e.age):null,aadhar_no:e.aadhar_no||null,position:e.position||"SUB",is_substitute:e.isSubstitute||!1,player_image:r||null,position_x:"number"!=typeof e.x||isNaN(e.x)?50:e.x,position_y:"number"!=typeof e.y||isNaN(e.y)?50:e.y}})),{error:a}=await s.from("team_players").insert(e);if(a)throw a;const i=new Map(e.map(e=>[e.player_name,e.player_image]));d(e=>e.map(e=>{if(!(null==e?void 0:e.name))return e;const a=i.get(e.name);return a?{...e,image:a}:e}))}return F(e),{success:!0,teamId:t}}catch(a){return v(a.message),{success:!1,error:a.message}}finally{N(!1)}},[S,c,m]),D=e.useMemo(()=>({step:i,setStep:r,teamData:c,setTeamData:o,players:m,setPlayers:d,loading:h,setLoading:g,saving:j,setSaving:N,error:y,setError:v,successTeamId:b,setSuccessTeamId:w,existingTeamId:S,setExistingTeamId:_,readOnlyMode:P,setReadOnlyMode:C,paymentStatus:k,setPaymentStatus:q,transactionId:L,setTransactionId:T,lastSavedStep:E,setLastSavedStep:F,resetForm:M,saveProgress:R}),[i,c,m,h,j,y,b,S,P,k,L,E,R]);return a.jsx(p.Provider,{value:D,children:t})};function N(){const{players:s,setPlayers:t,teamData:i,setTeamData:n,setStep:l,saveProgress:m,saving:d,error:h}=g(),u=e.useRef(null),[p,x]=e.useState(null),[f,j]=e.useState(!1),N=e.useCallback((e,a,i)=>{const n="number"!=typeof a||isNaN(a)?50:a,l="number"!=typeof i||isNaN(i)?50:i,r=s.find(a=>a.id===e);"GK"!==(null==r?void 0:r.position)&&t(a=>a.map(a=>a.id===e?{...a,x:n,y:l}:a))},[t,s]),y=e.useCallback((e,a)=>{const t=s.find(e=>e.id===a);"GK"!==(null==t?void 0:t.position)&&x(a)},[s]),v=e.useCallback(e=>{const a=u.current;if(!p||!a)return;e.preventDefault();const s=a.querySelector("svg");if(!s)return;const t=s.getBoundingClientRect(),i=e.touches?e.touches[0].clientX:e.clientX,n=e.touches?e.touches[0].clientY:e.clientY,l=(i-t.left)/t.width*100,r=(n-t.top)/t.height*100,c=Math.min(Math.max(l,0),100),o=Math.min(Math.max(r,0),100);N(p,c,o)},[p,N]),b=e.useCallback(()=>{x(null)},[]);e.useEffect(()=>{if(!f&&i.formation&&s.length>0){const e=r(s,i.formation);t(e),j(!0)}},[]);return a.jsxs("form",{className:"registration-form",onSubmit:async e=>{e.preventDefault();(await m(3)).success&&l(4)},children:[a.jsx("h3",{children:"Step 3 · Formation & Positions"}),a.jsx("p",{className:"step-description",children:"Choose a preset formation below, then drag players to customize positions."}),a.jsxs("div",{className:"formation-instruction-box",children:[a.jsx("div",{className:"instruction-icon",children:a.jsx("i",{className:"fas fa-hand-pointer"})}),a.jsxs("div",{className:"instruction-content",children:[a.jsx("strong",{className:"instruction-title",children:"Interactive Field"}),a.jsx("p",{className:"instruction-text",children:"Click and drag any player to reposition them (GK is locked)"})]})]}),a.jsxs("div",{className:"formation-presets-section",children:[a.jsxs("div",{className:"presets-header",children:[a.jsx("i",{className:"fas fa-chess-board"}),a.jsx("span",{className:"presets-title",children:"Choose Formation"})]}),a.jsx("div",{className:"formation-buttons-grid",children:c.map(e=>a.jsx("button",{type:"button",className:"formation-preset-btn "+(i.formation===e?"active":""),onClick:()=>(e=>{t(a=>r(a,e)),n(a=>({...a,formation:e}))})(e),children:a.jsx("span",{className:"formation-name",children:e})},e))})]}),a.jsx("div",{ref:u,className:"formation-field-container",children:a.jsx(o,{players:s.filter(e=>!e.isSubstitute),editable:!0,onDragStart:y,onDrag:v,onDragEnd:b})}),h&&a.jsx("p",{className:"auth-error",children:h}),a.jsxs("div",{className:"form-actions",children:[a.jsx("button",{type:"button",className:"secondary-btn",onClick:()=>l(2),disabled:d,children:"Back"}),a.jsx("button",{type:"submit",className:"primary-btn",disabled:d,children:d?a.jsxs(a.Fragment,{children:[a.jsx("i",{className:"fas fa-spinner fa-spin"})," Saving..."]}):a.jsxs(a.Fragment,{children:[a.jsx("i",{className:"fas fa-save"})," Save & Review"]})})]})]})}function y(){const{teamData:t,resetForm:i,paymentStatus:n,successTeamId:l,setPaymentStatus:r}=g(),[c,o]=e.useState(!0);e.useEffect(()=>{(async()=>{if(l)try{const{data:e,error:a}=await s.from("team_registrations").select("status, payment_status").eq("id",l).single();if(a)throw a;e&&("confirmed"===e.status||"confirmed"===e.payment_status?r("confirmed"):e.payment_status&&r(e.payment_status))}catch(e){}finally{o(!1)}else o(!1)})()},[l,r]);const m="confirmed"===n;return c?a.jsx("div",{className:"registration-form registration-complete",children:a.jsx("div",{className:"complete-container",children:a.jsxs("div",{className:"loading-content",children:[a.jsx("div",{className:"spinner"}),a.jsx("p",{children:"Loading registration status..."})]})})}):a.jsx("div",{className:"registration-form registration-complete",children:a.jsxs("div",{className:"complete-container",children:[a.jsx("div",{className:"complete-icon",children:a.jsx("div",{className:"icon-circle "+(m?"confirmed":"pending"),children:a.jsx("i",{className:"fas "+(m?"fa-check":"fa-clock")})})}),a.jsx("h2",{children:m?"Registration Confirmed!":"Registration Submitted!"}),a.jsxs("div",{className:"complete-team-info",children:[t.teamLogo&&a.jsx("img",{src:t.teamLogo,alt:t.teamName,className:"complete-team-logo"}),a.jsx("h3",{children:t.teamName}),a.jsxs("span",{className:"complete-category",children:["open-age"===t.category?"Open Age":"Under 17"," Category"]})]}),a.jsx("div",{className:"complete-message",children:m?a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"confirmation-badge",children:[a.jsx("i",{className:"fas fa-check-circle"}),a.jsx("span",{children:"Payment Verified"})]}),a.jsxs("p",{className:"main-message",children:["Your registration for ",a.jsx("strong",{children:"Muqawama 2026"})," has been confirmed!"]}),a.jsx("p",{className:"sub-message",children:"Welcome to the tournament! Your team is now officially registered."})]}):a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"verification-badge",children:[a.jsx("i",{className:"fas fa-hourglass-half"}),a.jsx("span",{children:"Payment Verification Pending"})]}),a.jsxs("p",{className:"main-message",children:["Your registration for ",a.jsx("strong",{children:"Muqawama 2026"})," has been submitted successfully!"]}),a.jsxs("p",{className:"sub-message",children:["We have received your payment screenshot and it is being verified by our team. You will receive confirmation within ",a.jsx("strong",{children:"24 hours"}),"."]})]})}),a.jsxs("div",{className:"complete-details",children:[a.jsx("h4",{children:"What Happens Next?"}),a.jsxs("ul",{className:"next-steps-list",children:[!m&&a.jsxs("li",{children:[a.jsx("i",{className:"fas fa-search-dollar"}),a.jsx("span",{children:"Our team will verify your payment within 24 hours"})]}),a.jsxs("li",{children:[a.jsx("i",{className:"fas fa-phone"}),a.jsx("span",{children:"The organisers will get in touch with you soon"})]}),a.jsxs("li",{children:[a.jsx("i",{className:"fas fa-calendar-check"}),a.jsx("span",{children:"Fixture details will be shared before the tournament"})]}),a.jsxs("li",{children:[a.jsx("i",{className:"fas fa-id-card"}),a.jsx("span",{children:"Player ID cards will be issued at the venue"})]})]})]}),a.jsxs("div",{className:"complete-contact",children:[a.jsx("p",{children:"Questions? Reach out to us:"}),a.jsxs("div",{className:"contact-links",children:[a.jsxs("a",{href:"mailto:muqawamah@sio-abulfazal.org",children:[a.jsx("i",{className:"fas fa-envelope"})," muqawamah@sio-abulfazal.org"]}),a.jsxs("a",{href:"https://instagram.com/muqawama2026",target:"_blank",rel:"noopener noreferrer",children:[a.jsx("i",{className:"fab fa-instagram"})," @muqawama2026"]})]})]}),a.jsx("div",{className:"complete-actions",children:a.jsxs("button",{type:"button",className:"primary-btn",onClick:()=>{i(),window.location.href="/muqawamah/2026/"},children:[a.jsx("i",{className:"fas fa-home"})," Back to Tournament Page"]})})]})})}const v={"open-age":{label:"Open Age",amount:2e3,qrCode:"/assets/img/Muqawama/qr-2000.svg"},u17:{label:"Under 17",amount:1800,qrCode:"/assets/img/Muqawama/qr-1800.svg"}};function b(){const{teamData:t,players:i,setStep:l,loading:r,setLoading:c,error:o,setError:h,existingTeamId:u,setExistingTeamId:p,setSuccessTeamId:x,paymentStatus:f,setPaymentStatus:j}=g(),[N,b]=e.useState(null),[w,S]=e.useState(null),[_,P]=e.useState(0),[C,k]=e.useState(!1),[q,L]=e.useState(!1),T=e.useRef(null),E=t.category||"open-age",F=v[E],M=F.amount;return"success"===f||"pending_verification"===f||"confirmed"===f?a.jsx(y,{}):a.jsxs("div",{className:"registration-form payment-checkout",children:[a.jsx("h3",{children:"Step 5 · Payment"}),a.jsx("p",{className:"step-description",children:"Scan the QR code, pay and upload the screenshot."}),a.jsxs("section",{className:"checkout-section",children:[a.jsxs("h4",{children:[a.jsx("i",{className:"fas fa-receipt"})," Order Summary"]}),a.jsxs("div",{className:"order-summary-card",children:[a.jsxs("div",{className:"order-item",children:[a.jsxs("div",{className:"order-item-info",children:[a.jsx("span",{className:"item-name",children:"Team Registration"}),a.jsxs("span",{className:"item-detail",children:[t.teamName," • ",F.label]})]}),a.jsxs("span",{className:"item-price",children:["₹",F.amount]})]}),a.jsxs("div",{className:"order-total",children:[a.jsx("span",{children:"Total Amount"}),a.jsxs("span",{className:"total-price",children:["₹",M]})]})]})]}),a.jsxs("section",{className:"checkout-section qr-section",children:[a.jsxs("h4",{children:[a.jsx("i",{className:"fas fa-qrcode"})," Scan & Pay"]}),a.jsxs("div",{className:"qr-payment-container",children:[a.jsx("div",{className:"qr-code-wrapper",children:a.jsx("img",{src:F.qrCode,alt:`Pay ₹${M} via UPI`,className:"qr-code-image"})}),a.jsxs("a",{href:F.qrCode,download:`muqawama-payment-qr-${M}.svg`,className:"download-qr-btn",children:[a.jsx("i",{className:"fas fa-download"})," Download QR Code"]}),a.jsxs("div",{className:"qr-instructions",children:[a.jsxs("div",{className:"instruction-step",children:[a.jsx("span",{className:"step-number",children:"1"}),a.jsx("span",{children:"Open any UPI app (GPay, PhonePe, Paytm, etc.)"})]}),a.jsxs("div",{className:"instruction-step",children:[a.jsx("span",{className:"step-number",children:"2"}),a.jsxs("span",{children:["Scan the QR code and pay ",a.jsxs("strong",{children:["₹",M]})]})]}),a.jsxs("div",{className:"instruction-step",children:[a.jsx("span",{className:"step-number",children:"3"}),a.jsx("span",{children:"Take a screenshot of the payment confirmation"})]}),a.jsxs("div",{className:"instruction-step",children:[a.jsx("span",{className:"step-number",children:"4"}),a.jsx("span",{children:"Upload the screenshot below"})]})]})]})]}),a.jsxs("section",{className:"checkout-section",children:[a.jsxs("h4",{children:[a.jsx("i",{className:"fas fa-upload"})," Upload Payment Screenshot"]}),a.jsxs("div",{className:"screenshot-upload-container",children:[a.jsx("input",{type:"file",ref:T,onChange:async e=>{const a=e.target.files[0];if(a)if(a.type.startsWith("image/"))if(a.size>5242880)h("Image size should be less than 5MB");else try{h(null);const e=await m(a,{maxWidth:1200,maxHeight:1200,quality:.85,outputFormat:"image/webp"});d(e),Math.round(a.size/1024);b(e),S(e)}catch(s){h("Failed to process image. Please try another file.")}else h("Please upload an image file (JPG, PNG, etc.)")},accept:"image/*",style:{display:"none"}}),w?a.jsxs("div",{className:"screenshot-preview",children:[a.jsx("img",{src:w,alt:"Payment Screenshot"}),a.jsxs("button",{type:"button",className:"remove-screenshot-btn",onClick:()=>{b(null),S(null),T.current&&(T.current.value="")},children:[a.jsx("i",{className:"fas fa-times"})," Remove"]})]}):a.jsxs("div",{className:"screenshot-dropzone",onClick:()=>{var e;return null==(e=T.current)?void 0:e.click()},children:[a.jsx("i",{className:"fas fa-cloud-upload-alt"}),a.jsx("p",{children:"Click to upload payment screenshot"}),a.jsx("span",{children:"JPG, PNG up to 5MB"})]})]}),_>0&&_<100&&a.jsxs("div",{className:"upload-progress",children:[a.jsx("div",{className:"progress-bar",children:a.jsx("div",{className:"progress-fill",style:{width:`${_}%`}})}),a.jsxs("span",{children:["Uploading... ",_,"%"]})]})]}),a.jsxs("section",{className:"checkout-section",children:[a.jsxs("h4",{children:[a.jsx("i",{className:"fas fa-users"})," Registration Details"]}),a.jsxs("div",{className:"checkout-team-summary",children:[a.jsxs("div",{className:"team-mini-card",children:[t.teamLogo&&a.jsx("img",{src:t.teamLogo,alt:t.teamName,className:"team-mini-logo"}),a.jsxs("div",{className:"team-mini-info",children:[a.jsx("span",{className:"team-mini-name",children:t.teamName}),a.jsxs("span",{className:"team-mini-category",children:[F.label," • ",i.length," Players"]})]})]}),a.jsxs("div",{className:"captain-info",children:[a.jsxs("span",{children:[a.jsx("i",{className:"fas fa-user"})," ",t.captainName]}),a.jsxs("span",{children:[a.jsx("i",{className:"fas fa-envelope"})," ",t.captainEmail]})]})]})]}),o&&a.jsxs("p",{className:"auth-error",children:[a.jsx("i",{className:"fas fa-exclamation-circle"})," ",o]}),a.jsxs("div",{className:"form-actions",children:[a.jsx("button",{type:"button",className:"secondary-btn",onClick:()=>l(4),disabled:r,children:"Back to Review"}),a.jsx("button",{type:"button",className:"primary-btn pay-btn",onClick:()=>k(!0),disabled:r||!N,children:r?a.jsxs(a.Fragment,{children:[a.jsx("i",{className:"fas fa-spinner fa-spin"})," Submitting..."]}):a.jsxs(a.Fragment,{children:[a.jsx("i",{className:"fas fa-check-circle"})," Submit Registration"]})})]}),a.jsxs("p",{className:"terms-note",children:[a.jsx("i",{className:"fas fa-info-circle"})," Your registration will be verified within 24 hours after payment confirmation."]}),C&&a.jsx("div",{className:"terms-modal-overlay",onClick:()=>k(!1),children:a.jsxs("div",{className:"terms-modal",onClick:e=>e.stopPropagation(),children:[a.jsxs("div",{className:"terms-modal-header",children:[a.jsx("i",{className:"fas fa-file-contract"}),a.jsx("h3",{children:"Confirm Registration"})]}),a.jsxs("div",{className:"terms-modal-content",children:[a.jsx("p",{children:"By submitting this registration, you confirm that:"}),a.jsxs("ul",{className:"terms-checklist",children:[a.jsxs("li",{children:[a.jsx("i",{className:"fas fa-check"}),a.jsx("span",{children:"All information provided is accurate and complete"})]}),a.jsxs("li",{children:[a.jsx("i",{className:"fas fa-check"}),a.jsxs("span",{children:["You agree to the ",a.jsx("a",{href:"/muqawamah/terms-and-conditions/",target:"_blank",rel:"noopener noreferrer",children:"Terms & Conditions"})]})]}),a.jsxs("li",{children:[a.jsx("i",{className:"fas fa-check"}),a.jsxs("span",{children:["You agree to the ",a.jsx("a",{href:"/muqawamah/privacy-policy/",target:"_blank",rel:"noopener noreferrer",children:"Privacy Policy"})]})]}),a.jsxs("li",{children:[a.jsx("i",{className:"fas fa-check"}),a.jsx("span",{children:"You consent to AI-enhanced player images"})]}),a.jsxs("li",{children:[a.jsx("i",{className:"fas fa-check"}),a.jsxs("span",{children:["You understand the ",a.jsx("a",{href:"/muqawamah/refund-policy/",target:"_blank",rel:"noopener noreferrer",children:"Refund Policy"})]})]}),a.jsxs("li",{children:[a.jsx("i",{className:"fas fa-check"}),a.jsx("span",{children:"All players meet the category age requirements"})]})]}),a.jsxs("div",{className:"terms-checkbox-label "+(q?"checked":""),onClick:()=>L(!q),children:[a.jsx("div",{className:"custom-checkbox",children:q&&a.jsx("i",{className:"fas fa-check"})}),a.jsx("span",{children:"I accept all the above terms and conditions"})]})]}),a.jsxs("div",{className:"terms-modal-actions",children:[a.jsx("button",{type:"button",className:"secondary-btn",onClick:()=>{k(!1),L(!1)},children:"Cancel"}),a.jsx("button",{type:"button",className:"primary-btn",disabled:!q||r,onClick:()=>{k(!1),(async()=>{if(N){c(!0),h(null),P(10);try{const{data:{user:e}}=await s.auth.getUser();if(!e)throw new Error("You must be logged in to proceed.");P(20),P(40);let a=u;if(u){const{error:e}=await s.from("team_registrations").update({team_name:t.teamName,category:t.category,team_logo:t.teamLogo,captain_name:t.captainName,captain_email:t.captainEmail,captain_phone:t.captainPhone,formation:t.formation,status:"pending_verification",payment_amount:M,payment_screenshot:null,payment_status:"pending_verification",submitted_at:(new Date).toISOString()}).eq("id",u);if(e)throw e}else{const{data:i,error:n}=await s.from("team_registrations").insert({user_id:e.id,team_name:t.teamName,category:t.category,team_logo:t.teamLogo,captain_name:t.captainName,captain_email:t.captainEmail,captain_phone:t.captainPhone,formation:t.formation,status:"pending_verification",payment_amount:M,payment_screenshot:null,payment_status:"pending_verification",submitted_at:(new Date).toISOString()}).select().single();if(n)throw n;a=i.id,p(a)}P(60);const r=await n({value:N,path:`registrations/${a}/payment_screenshot.webp`});if(r){const{error:e}=await s.from("team_registrations").update({payment_screenshot:r}).eq("id",a);if(e)throw e}await s.from("team_players").delete().eq("team_id",a);const c=i.map(e=>({team_id:a,player_name:e.name||"",player_age:e.age?parseInt(e.age):null,aadhar_no:e.aadhar_no||null,position:e.position||"SUB",is_substitute:e.isSubstitute||!1,player_image:e.image||null,position_x:"number"!=typeof e.x||isNaN(e.x)?50:e.x,position_y:"number"!=typeof e.y||isNaN(e.y)?50:e.y}));P(80);const{error:o}=await s.from("team_players").insert(c);if(o)throw o;P(100),x(a),j("pending_verification"),l(6)}catch(e){h(e.message)}finally{c(!1),P(0)}}else h("Please upload the payment screenshot")})()},children:r?a.jsxs(a.Fragment,{children:[a.jsx("i",{className:"fas fa-spinner fa-spin"})," Submitting..."]}):a.jsxs(a.Fragment,{children:[a.jsx("i",{className:"fas fa-check-circle"})," Confirm & Submit"]})})]})]})})]})}const w=["GK","CB","LB","RB","CDM","CM","CAM","LM","RM","CF","ST"];function S(){const{players:s,setPlayers:t,setStep:i,saveProgress:n,saving:l,error:r,teamData:c}=g(),[o,h]=e.useState(null),u="open-age"===c.category;e.useEffect(()=>{c.captainName&&s[0]&&!s[0].name&&t(e=>e.map((e,a)=>0===a?{...e,name:c.captainName}:e))},[c.captainName,t]);const p=(e,a,s)=>{t(t=>t.map((t,i)=>i===e?{...t,[a]:s}:t))},x=s.filter(e=>!e.isSubstitute),f=s.filter(e=>e.isSubstitute),j=x[0],N=x.slice(1),y=(e,s,t=!1)=>{const i=e.isSubstitute,n=i&&e.name,l=!i||n;return a.jsxs("div",{className:`player-card ${t?"captain-card":""} ${i?"substitute-card":""}`,children:[t&&a.jsxs("div",{className:"captain-badge",children:[a.jsx("i",{className:"fas fa-star"})," Team Captain"]}),i&&!n&&a.jsxs("div",{className:"optional-badge",children:[a.jsx("i",{className:"fas fa-plus-circle"})," Optional"]}),a.jsxs("label",{children:[t?"Captain Name":"Player Name",a.jsx("input",{type:"text",value:e.name,onChange:e=>p(s,"name",e.target.value),placeholder:t?c.captainName||"Captain Name":i?"Substitute Name (optional)":`${e.position} Player`,required:!i})]}),a.jsxs("label",{children:["Age",a.jsx("input",{type:"number",value:e.age||"",onChange:e=>p(s,"age",e.target.value),placeholder:"e.g., 22",min:"10",max:"60",required:l})]}),!u&&a.jsxs("label",{children:["Aadhar Number",a.jsx("input",{type:"text",value:e.aadhar_no||"",onChange:e=>{const a=e.target.value.replace(/\D/g,"");a.length<=12&&p(s,"aadhar_no",a)},placeholder:"12-digit Aadhar number",maxLength:"12",pattern:"[0-9]{12}",required:l}),a.jsx("span",{className:"input-hint",children:"Enter 12-digit Aadhar number (required for U17)"})]}),!e.isSubstitute&&a.jsxs("label",{children:["Position",a.jsx("select",{value:e.position,onChange:e=>p(s,"position",e.target.value),children:w.map(e=>a.jsx("option",{value:e,children:e},e))})]}),a.jsxs("label",{className:"file-label",children:["Player Photo",o===s&&a.jsxs("div",{className:"compressing-indicator",children:[a.jsx("i",{className:"fas fa-spinner fa-spin"}),a.jsx("span",{children:"Compressing image..."})]}),e.image&&o!==s&&a.jsxs("div",{className:"uploaded-photo-preview",children:[a.jsxs("div",{className:"photo-preview-container",children:[a.jsx("img",{src:e.image,alt:"Player photo",className:"photo-preview"}),a.jsx("div",{className:"photo-overlay",children:a.jsx("i",{className:"fas fa-check-circle"})})]}),a.jsxs("div",{className:"uploaded-file-info",children:[a.jsx("i",{className:"fas fa-check-circle"}),a.jsxs("span",{className:"file-name-text",children:[a.jsx("strong",{children:"Uploaded:"})," ",e.imageFileName||"Photo uploaded"]}),a.jsx("span",{className:"file-change-hint",children:"(Click to change)"})]})]}),a.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var a;return(async(e,a)=>{if(a)if(a.size>2097152)alert("Player photo must be under 2MB");else try{h(e);const s=await m(a,{maxWidth:600,maxHeight:600,quality:.85,outputFormat:"image/webp"});d(s),Math.round(a.size/1024),p(e,"image",s),p(e,"imageFileName",a.name.replace(/\.(jpg|jpeg|png)$/i,".webp"))}catch(s){alert("Failed to process image. Please try another file.")}finally{h(null)}})(s,null==(a=e.target.files)?void 0:a[0])},disabled:o===s}),!e.image&&o!==s&&a.jsx("span",{className:"input-hint",children:"JPG/PNG up to 2MB. Optional."})]})]},e.id)};return a.jsxs("form",{className:"registration-form",onSubmit:async e=>{if(e.preventDefault(),!(()=>{const e=x.every(e=>{const a=e.name&&""!==e.name.trim()&&e.age;return u?a:a&&e.aadhar_no&&12===e.aadhar_no.length}),a=f.filter(e=>e.name&&""!==e.name.trim()).every(e=>{const a=e.name&&e.age;return u?a:a&&e.aadhar_no&&12===e.aadhar_no.length});return e&&a})()){return void alert(`Please fill out name and age${u?"":" and Aadhar number (12 digits)"} for all main players. Substitutes are optional.`)}(await n(2)).success&&i(3)},children:[a.jsx("h3",{children:"Step 2 · Players"}),a.jsx("p",{className:"step-description",children:"Start with the captain, then add 6 more players and 4 substitutes."}),a.jsx("h4",{children:"Captain"}),a.jsx("div",{className:"captain-section",children:j&&y(j,s.indexOf(j),!0)}),a.jsx("h4",{children:"Other Main Players"}),a.jsx("div",{className:"players-grid",children:N.map(e=>y(e,s.indexOf(e)))}),a.jsxs("h4",{children:["Substitutes ",a.jsx("span",{className:"optional-label",children:"(Optional)"})]}),a.jsx("p",{className:"step-description",style:{marginTop:"-10px",marginBottom:"15px"},children:"Add 1-4 substitutes as needed. You can leave any substitute cards empty if you don't have players."}),a.jsx("div",{className:"players-grid",children:f.map(e=>y(e,s.indexOf(e)))}),r&&a.jsx("p",{className:"auth-error",children:r}),a.jsxs("div",{className:"form-actions",children:[a.jsx("button",{type:"button",className:"secondary-btn",onClick:()=>i(1),disabled:l,children:"Back"}),a.jsx("button",{type:"submit",className:"primary-btn",disabled:l,children:l?a.jsxs(a.Fragment,{children:[a.jsx("i",{className:"fas fa-spinner fa-spin"})," Saving..."]}):a.jsxs(a.Fragment,{children:[a.jsx("i",{className:"fas fa-save"})," Save & Continue"]})})]})]})}function _({readOnly:e=!1}){const{teamData:s,players:t,setStep:i,existingTeamId:n}=g();return a.jsxs("div",{className:"registration-form",children:[a.jsxs("h3",{children:["Step 4 · Review & ",n?"Update":"Submit"]}),a.jsxs("p",{className:"step-description",children:["Verify everything looks good before ",n?"updating":"submitting"," your team."]}),a.jsxs("section",{className:"summary-section",children:[a.jsx("h4",{children:"Team Information"}),a.jsxs("div",{className:"team-info-card",children:[a.jsxs("div",{className:"team-info-header",children:[a.jsx("div",{className:"team-logo-large",children:s.teamLogo?a.jsx("img",{src:s.teamLogo,alt:`${s.teamName} logo`}):a.jsx("div",{className:"team-logo-placeholder-large",children:a.jsx("i",{className:"fas fa-shield-alt"})})}),a.jsxs("div",{className:"team-info-main",children:[a.jsx("h3",{className:"team-name-display",children:s.teamName}),a.jsxs("span",{className:"team-category-badge",children:[a.jsx("i",{className:"fas fa-trophy"})," ","open-age"===s.category?"Open Age":"Under 17"]})]})]}),a.jsxs("div",{className:"team-info-details",children:[a.jsxs("div",{className:"info-row",children:[a.jsxs("div",{className:"info-item",children:[a.jsx("i",{className:"fas fa-user-tie"}),a.jsxs("div",{className:"info-content",children:[a.jsx("span",{className:"info-label",children:"Captain"}),a.jsx("span",{className:"info-value",children:s.captainName})]})]}),a.jsxs("div",{className:"info-item",children:[a.jsx("i",{className:"fas fa-envelope"}),a.jsxs("div",{className:"info-content",children:[a.jsx("span",{className:"info-label",children:"Email"}),a.jsx("span",{className:"info-value",children:s.captainEmail})]})]})]}),s.captainPhone&&a.jsxs("div",{className:"info-row",children:[a.jsxs("div",{className:"info-item",children:[a.jsx("i",{className:"fas fa-phone"}),a.jsxs("div",{className:"info-content",children:[a.jsx("span",{className:"info-label",children:"Phone"}),a.jsx("span",{className:"info-value",children:s.captainPhone})]})]}),a.jsxs("div",{className:"info-item",children:[a.jsx("i",{className:"fas fa-futbol"}),a.jsxs("div",{className:"info-content",children:[a.jsx("span",{className:"info-label",children:"Formation"}),a.jsx("span",{className:"info-value",children:s.formation})]})]})]}),!s.captainPhone&&a.jsx("div",{className:"info-row",children:a.jsxs("div",{className:"info-item",children:[a.jsx("i",{className:"fas fa-futbol"}),a.jsxs("div",{className:"info-content",children:[a.jsx("span",{className:"info-label",children:"Formation"}),a.jsx("span",{className:"info-value",children:s.formation})]})]})})]})]})]}),a.jsxs("section",{className:"summary-section",children:[a.jsx("h4",{children:"Players"}),a.jsx("div",{className:"player-card-grid",children:t.filter(e=>e.name&&""!==e.name.trim()).map((e,t)=>{var i,n;return a.jsxs("div",{className:"player-card-badge simple "+(e.isSubstitute?"substitute":""),children:[a.jsxs("div",{className:"badge-header",children:[a.jsxs("div",{className:"badge-team",children:[a.jsx("div",{className:"team-logo",children:s.teamLogo?a.jsx("img",{src:s.teamLogo,alt:`${s.teamName} logo`}):a.jsx("div",{className:"team-logo-placeholder",children:(null==(n=null==(i=s.teamName)?void 0:i.charAt(0))?void 0:n.toUpperCase())||"T"})}),a.jsxs("div",{className:"team-meta",children:[a.jsx("span",{className:"team-name",children:s.teamName||"Team name"}),a.jsx("span",{className:"player-role",children:e.isSubstitute?"Substitute":e.position||"Player"})]})]}),a.jsx("div",{className:"muqawama-logo",children:a.jsx("img",{src:"/assets/img/MuqawamaLogo.png",alt:"Muqawama 2026"})})]}),a.jsx("div",{className:"badge-photo",children:e.image?a.jsx("img",{src:e.image,alt:e.name||e.position}):a.jsx("div",{className:"badge-photo-placeholder",children:a.jsx("i",{className:"fas fa-user"})})}),a.jsx("div",{className:"badge-player-info",children:a.jsx("span",{className:"player-name",children:e.name})})]},e.id||t)})})]}),a.jsxs("section",{className:"summary-section",children:[a.jsx("h4",{children:"Formation Preview"}),a.jsx("div",{children:a.jsx(o,{players:t.filter(e=>!e.isSubstitute),editable:!1,showDownload:!0})})]}),!e&&a.jsxs("div",{className:"form-actions",children:[a.jsx("button",{type:"button",className:"secondary-btn",onClick:()=>i(3),children:"Back"}),a.jsx("button",{type:"button",className:"primary-btn",onClick:()=>{i(5)},children:"Proceed to Payment"})]})]})}const P=[{value:"open-age",label:"Open Age"},{value:"u17",label:"Under 17"}];function C(){const{teamData:s,setTeamData:t,setStep:i,saveProgress:n,saving:l,error:r}=g(),o=e.useRef(null),[h,u]=e.useState(!1),p=e=>{const{name:a,value:s}=e.target;t(e=>({...e,[a]:s}))};return a.jsxs("form",{className:"registration-form",onSubmit:async e=>{var a;if(e.preventDefault(),!s.teamLogo)return void alert("Please upload a team logo");if(10!==((null==(a=s.captainPhone)?void 0:a.replace(/\s/g,""))||"").length)return void alert("Please enter a valid 10-digit mobile number");(await n(1)).success&&i(2)},children:[a.jsx("h3",{children:"Step 1 · Team Details"}),a.jsx("p",{className:"step-description",children:"Tell us about your team and captain information."}),a.jsxs("label",{children:["Team Name",a.jsx("input",{type:"text",name:"teamName",value:s.teamName,onChange:p,placeholder:"e.g., Rising Stars",required:!0})]}),a.jsxs("label",{children:["Category",a.jsx("select",{name:"category",value:s.category,onChange:p,children:P.map(e=>a.jsx("option",{value:e.value,children:e.label},e.value))})]}),a.jsxs("label",{className:"file-label",children:["Team Logo",h&&a.jsxs("div",{className:"compressing-indicator",children:[a.jsx("i",{className:"fas fa-spinner fa-spin"}),a.jsx("span",{children:"Compressing image..."})]}),s.teamLogo&&!h&&a.jsxs("div",{className:"uploaded-photo-preview",children:[a.jsxs("div",{className:"photo-preview-container",children:[a.jsx("img",{src:s.teamLogo,alt:"Team logo",className:"photo-preview"}),a.jsx("div",{className:"photo-overlay",children:a.jsx("i",{className:"fas fa-check-circle"})})]}),a.jsxs("div",{className:"uploaded-file-info",children:[a.jsx("i",{className:"fas fa-check-circle"}),a.jsx("span",{children:s.teamLogoFileName?`Uploaded: ${s.teamLogoFileName}`:"Logo uploaded"}),a.jsx("span",{className:"file-change-hint",children:"(Click to change)"})]})]}),a.jsx("input",{type:"file",accept:"image/*",ref:o,onChange:async e=>{var a;const s=null==(a=e.target.files)?void 0:a[0];if(s){if(s.size>2097152)return alert("Logo size must be under 2MB"),void(o.current.value="");try{u(!0);const e=await m(s,{maxWidth:800,maxHeight:800,quality:.85,outputFormat:"image/webp"});d(e),Math.round(s.size/1024);t(a=>({...a,teamLogo:e,teamLogoFileName:s.name.replace(/\.(jpg|jpeg|png)$/i,".webp")}))}catch(i){alert("Failed to process image. Please try another file."),o.current.value=""}finally{u(!1)}}},disabled:h}),!s.teamLogo&&!h&&a.jsx("span",{className:"input-hint",children:"JPG/PNG up to 2MB. Displayed across the tournament site."})]}),a.jsxs("label",{children:["Preferred Formation",a.jsx("select",{name:"formation",value:s.formation,onChange:p,children:c.map(e=>a.jsx("option",{value:e,children:e},e))}),a.jsx("span",{className:"input-hint",children:"This will be the starting layout in Step 3. You can still adjust players later."})]}),a.jsxs("div",{className:"grid-2",children:[a.jsxs("label",{children:["Captain Name",a.jsx("input",{type:"text",name:"captainName",value:s.captainName,onChange:p,required:!0})]}),a.jsxs("label",{children:["Captain Email",a.jsx("input",{type:"email",name:"captainEmail",value:s.captainEmail,onChange:p,required:!0})]})]}),a.jsxs("label",{children:["Captain Phone",a.jsx("input",{type:"tel",name:"captainPhone",value:s.captainPhone||"",onChange:e=>{const a=e.target.value.replace(/\D/g,"");let s="";a&&(s=a.length<=5?a:`${a.slice(0,5)} ${a.slice(5,10)}`),t(e=>({...e,captainPhone:s}))},placeholder:"98765 43210",pattern:"[0-9\\s]{10,12}",maxLength:11,onInvalid:e=>{var a;const t=e.target;((null==(a=s.captainPhone)?void 0:a.replace(/\s/g,""))||"").length<10?t.setCustomValidity("Please enter a valid 10-digit mobile number"):t.setCustomValidity("")},onInput:e=>{e.target.setCustomValidity("")},required:!0}),a.jsxs("span",{className:"input-hint",children:[a.jsx("i",{className:"fas fa-info-circle"})," 10-digit mobile number (e.g., 98765 43210)"]})]}),r&&a.jsx("p",{className:"auth-error",children:r}),a.jsx("div",{className:"form-actions",children:a.jsx("button",{type:"submit",className:"primary-btn",disabled:l,children:l?a.jsxs(a.Fragment,{children:[a.jsx("i",{className:"fas fa-spinner fa-spin"})," Saving..."]}):a.jsxs(a.Fragment,{children:[a.jsx("i",{className:"fas fa-save"})," Save & Continue"]})})})]})}const k=[{id:1,label:"Team"},{id:2,label:"Players"},{id:3,label:"Formation"},{id:4,label:"Review"},{id:5,label:"Payment"},{id:6,label:"Complete"}];function q(){const{step:e}=g(),s=k.slice(0,5);return 6===e?null:a.jsx("div",{className:"registration-stepper",children:s.map((s,t)=>a.jsxs("div",{className:`step ${e===s.id?"active":""} ${e>s.id?"complete":""}`,children:[a.jsx("span",{className:"step-number",children:t+1}),a.jsx("span",{className:"step-label",children:s.label})]},s.id))})}function L(){const{step:i,setStep:n,setTeamData:l,setPlayers:r,setExistingTeamId:c,readOnlyMode:o,setReadOnlyMode:m,resetForm:d,existingTeamId:u,setPaymentStatus:p,setLastSavedStep:j}=g(),[v,w]=e.useState(null),[P,k]=e.useState(!0),[L,T]=e.useState(""),[E,F]=e.useState(!1),M=t.useRef(!1);e.useEffect(()=>{const e=new URLSearchParams(window.location.search).get("payment");"success"===e?(p("success"),n(5),window.history.replaceState({},"",window.location.pathname)):"failed"===e&&(p("failed"),n(5),window.history.replaceState({},"",window.location.pathname))},[]),e.useEffect(()=>{let e=!0;T("");(async()=>{try{const{data:a,error:t}=await Promise.race([s.auth.getUser(),new Promise((e,a)=>setTimeout(()=>a(new Error("getUser timeout")),3e3))]);if(!e)return;if(t){if("getUser timeout"===t.message)return w(null),d(),void k(!1);if("Auth session missing!"!==t.message)throw t}const i=(null==a?void 0:a.user)??null;i?(w(i),await R(i,{force:!0})):(w(null),d())}catch(a){e&&(w(null),d())}finally{e&&k(!1)}})();const{data:a}=s.auth.onAuthStateChange(async(a,s)=>{if(!e)return;["TOKEN_REFRESHED","USER_UPDATED"].includes(a)||("SIGNED_OUT"!==a&&(null==s?void 0:s.user)?"SIGNED_IN"===a&&(null==s?void 0:s.user)&&(M.current||(w(s.user),k(!0),await R(s.user,{force:!0}),k(!1))):(w(null),d(),n(1),M.current=!1))});return()=>{e=!1,a.subscription.unsubscribe()}},[]);const R=async(e,{force:a=!1}={})=>{if(!M.current||a){M.current=!0,F(!0),T("");try{const{data:a,error:t}=await s.from("team_registrations").select("*, team_players(*)").eq("user_id",e.id).maybeSingle();if(t&&"PGRST116"!==t.code)throw t;if(a){c(a.id),m(!1),l({teamName:a.team_name||"",category:a.category||"open-age",teamLogo:a.team_logo,captainName:a.captain_name||"",captainEmail:a.captain_email||e.email||"",captainPhone:a.captain_phone?a.captain_phone.replace(/^\+91\s?/,"").trim():"",formation:a.formation||"1-3-2-1"});const s=a.team_players&&a.team_players.length>0?a.team_players.map((e,a)=>({id:e.id||`player-${a}`,name:e.player_name||"",age:e.player_age||"",aadhar_no:e.aadhar_no||"",position:e.position||"SUB",isSubstitute:e.is_substitute,image:e.player_image,x:e.position_x??50,y:e.position_y??50})):x();if(r(s),"confirmed"===a.status)p("confirmed"),n(6);else if("pending_verification"===a.status)p("pending_verification"),n(6);else if("pending_payment"===a.status)n(4);else{const e=a.last_saved_step||1;j(e);n(e>=3?4:e+1)}}else c(null),m(!1),l({...f,captainEmail:e.email||""}),r(x()),n(1)}catch(t){T("Could not load your saved registration. You can continue and submitting will overwrite the previous data."),c(null),m(!1),l({...f,captainEmail:e.email||""}),r(x()),n(1)}finally{F(!1)}}};return P?a.jsx("div",{className:"loading-screen",children:a.jsxs("div",{className:"loading-content",children:[a.jsxs("div",{className:"logo-loader",children:[a.jsx("div",{className:"logo-ring"}),a.jsx("img",{src:"/assets/img/MuqawamaLogo.png",alt:"Muqawama",className:"logo-pulse"})]}),a.jsx("p",{children:"Loading your registration..."})]})}):v?a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"header-actions",children:[a.jsx("span",{className:"user-email",children:v.email}),a.jsxs("button",{type:"button",className:"logout-btn",onClick:async()=>{await s.auth.signOut(),w(null),n(1)},children:[a.jsx("i",{className:"fas fa-sign-out-alt"})," Logout"]})]}),a.jsx("div",{className:"registration-header",children:a.jsxs("div",{className:"registration-header-logo",children:[a.jsx("img",{src:"/assets/img/title.png",alt:"Muqawama 2026"}),a.jsx("h2",{className:"registration-header-title",children:"Team Registration"}),a.jsx("p",{children:u?"Edit your team registration and update any details.":"Complete all steps to confirm your team registration."})]})}),L&&a.jsx("p",{className:"auth-error",children:L}),a.jsx(q,{}),(()=>{switch(i){case 1:default:return a.jsx(C,{});case 2:return a.jsx(S,{});case 3:return a.jsx(N,{});case 4:return a.jsx(_,{});case 5:return a.jsx(b,{});case 6:return a.jsx(y,{})}})()]}):a.jsx(h,{onSuccess:w})}function T(){return e.useEffect(()=>(document.body.classList.add("registration-body"),()=>document.body.classList.remove("registration-body")),[]),a.jsx(j,{children:a.jsx("div",{className:"registration-container",children:a.jsx(L,{})})})}i.createRoot(document.getElementById("registration-root")).render(a.jsx(t.StrictMode,{children:a.jsx(T,{})}));
