<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Quran Ayat Generator - SIO-AFE</title>
    
    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
    <link rel="manifest" href="/assets/img/favicons/site.webmanifest">
    <meta name="msapplication-TileColor" content="#c2272b">
    <meta name="theme-color" content="#ffffff">

    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #c2272b;
            --secondary: #3475af;
            --dark: #333;
            --light: #f8f8f8;
            --gradient: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--light);
            color: var(--dark);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline-block;
        }

        .description {
            font-size: 1.1rem;
            color: #555;
            margin-bottom: 1.5rem;
        }

        .ayat-container {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .ayat-container::before {
            content: """;
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 150px;
            color: rgba(0, 0, 0, 0.03);
            line-height: 1;
            font-family: serif;
        }

        .arabic-text {
            font-family: 'Amiri', serif;
            font-size: 2rem;
            margin-bottom: 1rem;
            line-height: 1.7;
            text-align: right;
            direction: rtl;
        }

        .translation {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            line-height: 1.6;
            color: #555;
        }

        .reference {
            font-size: 1rem;
            text-align: right;
            color: var(--primary);
            font-weight: 500;
        }

        .btn {
            display: inline-block;
            background: var(--gradient);
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-container {
            text-align: center;
        }

        .loading {
            text-align: center;
            font-size: 1.2rem;
            color: #777;
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .filter-group select {
            width: 100%;
            padding: 0.7rem;
            border-radius: 5px;
            border: 1px solid #ddd;
            background-color: white;
            font-size: 1rem;
        }

        .juz-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .juz-checkbox {
            display: inline-flex;
            align-items: center;
            background: #f1f1f1;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            margin-bottom: 5px;
        }

        .juz-checkbox.active {
            background: var(--primary);
            color: white;
            font-weight: 500;
        }

        .juz-checkbox input {
            display: none;
        }

        .surah-list {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            display: none;
        }

        .surah-list h3 {
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .surah-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .surah-chip {
            background: #f1f1f1;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
        }

        footer {
            text-align: center;
            margin-top: 3rem;
            color: #777;
            font-size: 0.9rem;
        }

        footer a {
            color: var(--primary);
            text-decoration: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .arabic-text {
                font-size: 1.5rem;
            }
            
            .translation {
                font-size: 1rem;
            }
            
            .juz-checkboxes {
                max-height: 200px;
                overflow-y: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Itqan Quran Ayat Generator</h1>
            <p class="description">Discover verses from the Holy Quran to reflect upon and gain wisdom.</p>
        </header>

        <div class="filters">
            <div class="filter-group">
                <label>Juz (Section) - Select Multiple</label>
                <div class="juz-checkboxes" id="juz-checkboxes">
                    <!-- Juz checkboxes will be added by JavaScript -->
                </div>
                <div style="margin-top: 10px;">
                    <button id="clear-juz" class="btn" style="padding: 0.3rem 0.8rem; font-size: 0.9rem;">Clear All</button>
                    <button id="show-surah-list" class="btn" style="padding: 0.3rem 0.8rem; font-size: 0.9rem;">Show Surahs in Selected Juz</button>
                </div>
                <div style="margin-top: 10px; font-size: 0.9rem; color: #555;" id="surah-info">
                    Please select at least one Juz to generate random verses.
                </div>
            </div>
        </div>

        <div id="surah-list" class="surah-list">
            <h3>Surahs in Selected Juz</h3>
            <div id="surah-chips" class="surah-chips">
                <!-- Surah chips will be added by JavaScript -->
            </div>
        </div>

        <div class="ayat-container">
            <p id="loading" class="loading">Loading Quran data...</p>
            <p id="arabic-text" class="arabic-text" style="display: none;"></p>
            <p id="translation" class="translation" style="display: none;"></p>
            <p id="reference" class="reference" style="display: none;"></p>
        </div>

        <div class="btn-container">
            <button id="generate-btn" class="btn">Generate New Ayat</button>
        </div>

        <footer>
            <p>This tool is intended for educational and spiritual purposes. Please handle Quranic content with respect.</p>
            <p>Data source: <a href="https://github.com/risan/quran-json" target="_blank">Quran JSON</a></p>
        </footer>
    </div>

    <script>
        // Global variables
        let quranData = [];
        let juzData = {};
        let selectedJuzSet = new Set(); // Using a Set to store multiple selected Juz
        let juzToSurahMap = {}; // Mapping of which Surahs appear in each Juz
        let availableSurahs = new Set(); // Surahs available from selected Juz
        
        // DOM elements
        const arabicText = document.getElementById('arabic-text');
        const translation = document.getElementById('translation');
        const reference = document.getElementById('reference');
        const loading = document.getElementById('loading');
        const generateBtn = document.getElementById('generate-btn');
        const surahInfo = document.getElementById('surah-info');
        const juzCheckboxes = document.getElementById('juz-checkboxes');
        const clearJuzBtn = document.getElementById('clear-juz');
        const showSurahListBtn = document.getElementById('show-surah-list');
        const surahList = document.getElementById('surah-list');
        const surahChips = document.getElementById('surah-chips');
        
        // Event listeners
        window.addEventListener('DOMContentLoaded', initializeApp);
        generateBtn.addEventListener('click', generateRandomAyat);
        clearJuzBtn.addEventListener('click', clearJuzSelection);
        showSurahListBtn.addEventListener('click', showSurahsInSelectedJuz);
        
        // Initialize the app
        async function initializeApp() {
            try {
                // Fetch Quran data
                const response = await fetch('/assets/data/quran/quran.json');
                quranData = await response.json();
                
                // Check if quranData loaded properly
                if (!quranData || !Array.isArray(quranData) || quranData.length === 0) {
                    throw new Error('Quran data not loaded properly');
                }
                
                console.log(`Quran data loaded successfully with ${quranData.length} surahs`);
                
                // Create Juz data (approximate mapping)
                createJuzData();
                
                // Populate filters
                populateJuzCheckboxes();
                
                // Generate initial random ayat
                generateRandomAyat();
                
                // Hide loading message
                loading.style.display = 'none';
                arabicText.style.display = 'block';
                translation.style.display = 'block';
                reference.style.display = 'block';
                
            } catch (error) {
                console.error('Error initializing app:', error);
                loading.textContent = 'Error loading Quran data. Please try refreshing the page.';
            }
        }
        
        // Create a mapping of Juz to Surahs and verses (approximate)
        function createJuzData() {
            console.log("Starting to create Juz to Surah mapping...");
            
            // This is an approximate mapping of Juz divisions
            // In a production app, you would use a more accurate dataset
            const juzDivisions = [
                { surah: 1, verse: 1 },    // Juz 1 starts from Surah 1, Verse 1
                { surah: 2, verse: 142 },  // Juz 2
                { surah: 2, verse: 253 },  // Juz 3
                { surah: 3, verse: 92 },   // Juz 4
                { surah: 4, verse: 24 },   // Juz 5
                { surah: 4, verse: 148 },  // Juz 6
                { surah: 5, verse: 82 },   // Juz 7
                { surah: 6, verse: 111 },  // Juz 8
                { surah: 7, verse: 88 },   // Juz 9
                { surah: 8, verse: 41 },   // Juz 10
                { surah: 9, verse: 93 },   // Juz 11
                { surah: 11, verse: 6 },   // Juz 12
                { surah: 12, verse: 53 },  // Juz 13
                { surah: 15, verse: 1 },   // Juz 14
                { surah: 17, verse: 1 },   // Juz 15
                { surah: 18, verse: 75 },  // Juz 16
                { surah: 21, verse: 1 },   // Juz 17
                { surah: 23, verse: 1 },   // Juz 18
                { surah: 25, verse: 21 },  // Juz 19
                { surah: 27, verse: 56 },  // Juz 20
                { surah: 29, verse: 46 },  // Juz 21
                { surah: 33, verse: 31 },  // Juz 22
                { surah: 36, verse: 28 },  // Juz 23
                { surah: 39, verse: 32 },  // Juz 24
                { surah: 41, verse: 47 },  // Juz 25
                { surah: 46, verse: 1 },   // Juz 26
                { surah: 51, verse: 31 },  // Juz 27
                { surah: 58, verse: 1 },   // Juz 28
                { surah: 67, verse: 1 },   // Juz 29
                { surah: 78, verse: 1 }    // Juz 30
            ];
            
            // Initialize juzData and juzToSurahMap
            for (let i = 1; i <= 30; i++) {
                juzData[i] = [];
                juzToSurahMap[i] = new Set();
            }
            
            // Simple algorithm: For each Juz, assign all verses from start to next Juz start
            for (let juz = 1; juz <= 30; juz++) {
                console.log(`Creating data for Juz ${juz}...`);
                
                // Get start and end points for this Juz
                const startPoint = juzDivisions[juz - 1];
                const endPoint = (juz < 30) ? juzDivisions[juz] : { surah: 115, verse: 1 }; // End of the Quran
                
                const startSurahNum = startPoint.surah;
                const startVerseNum = startPoint.verse;
                const endSurahNum = endPoint.surah;
                const endVerseNum = endPoint.verse;
                
                console.log(`Juz ${juz}: From Surah ${startSurahNum}:${startVerseNum} to Surah ${endSurahNum}:${endVerseNum}`);
                
                // Find all Surahs in this range
                for (let surahIdx = 0; surahIdx < quranData.length; surahIdx++) {
                    const surah = quranData[surahIdx];
                    const surahNum = parseInt(surah.number);
                    
                    // Skip Surahs that are completely before this Juz
                    if (surahNum < startSurahNum) {
                        continue;
                    }
                    
                    // Skip Surahs that are completely after this Juz
                    if (surahNum > endSurahNum || (surahNum === endSurahNum && surahNum !== startSurahNum)) {
                        continue;
                    }
                    
                    // Keep track if any verses from this Surah are in this Juz
                    let hasVersesInJuz = false;
                    
                    // Check all verses in this Surah
                    for (let verseIdx = 0; verseIdx < surah.verses.length; verseIdx++) {
                        const verseNum = verseIdx + 1;
                        
                        // Skip verses before the start verse in the starting Surah
                        if (surahNum === startSurahNum && verseNum < startVerseNum) {
                            continue;
                        }
                        
                        // Skip verses after or at the end verse in the ending Surah
                        if (surahNum === endSurahNum && verseNum >= endVerseNum) {
                            continue;
                        }
                        
                        // This verse is in this Juz - add it to the data
                        juzData[juz].push({
                            surahIndex: surahIdx,
                            verseIndex: verseIdx
                        });
                        
                        hasVersesInJuz = true;
                    }
                    
                    // If this Surah has at least one verse in this Juz, add it to the map
                    if (hasVersesInJuz) {
                        juzToSurahMap[juz].add(surahIdx);
                        console.log(`  Added Surah ${surahNum} (${surah.englishName}) to Juz ${juz}`);
                    }
                }
                
                console.log(`Juz ${juz} contains ${juzToSurahMap[juz].size} Surahs and ${juzData[juz].length} verses`);
            }
            
            // Check for empty Juz
            for (let juz = 1; juz <= 30; juz++) {
                if (juzToSurahMap[juz].size === 0) {
                    console.error(`WARNING: Juz ${juz} has no Surahs!`);
                } else {
                    // For debugging, show the first 5 Surahs in this Juz
                    const surahList = Array.from(juzToSurahMap[juz])
                        .slice(0, 5)
                        .map(idx => `${quranData[idx].number}. ${quranData[idx].englishName}`)
                        .join(', ');
                    console.log(`Juz ${juz} sample Surahs: ${surahList}${juzToSurahMap[juz].size > 5 ? '...' : ''}`);
                }
            }
        }
        
        // Populate Juz checkboxes
        function populateJuzCheckboxes() {
            juzCheckboxes.innerHTML = ''; // Clear existing checkboxes first
            
            for (let i = 1; i <= 30; i++) {
                const label = document.createElement('label');
                label.className = 'juz-checkbox';
                label.dataset.juz = i;
                
                // Create checkbox
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = i;
                checkbox.style.display = 'none';
                
                // Add text node
                const text = document.createTextNode(`Juz ${i}`);
                
                // Append checkbox and text to label
                label.appendChild(checkbox);
                label.appendChild(text);
                
                // Add event listener to toggle selection
                label.onclick = function(event) {
                    event.preventDefault(); // Prevent default checkbox behavior
                    const juz = parseInt(this.dataset.juz);
                    
                    if (selectedJuzSet.has(juz)) {
                        selectedJuzSet.delete(juz);
                        this.classList.remove('active');
                        checkbox.checked = false;
                    } else {
                        selectedJuzSet.add(juz);
                        this.classList.add('active');
                        checkbox.checked = true;
                    }
                    
                    // Update available Surahs based on selected Juz
                    updateAvailableSurahs();
                    
                    // Generate a new Ayat when Juz selection changes
                    generateRandomAyat();
                    
                    // Log selection for debugging
                    console.log('Selected Juz:', Array.from(selectedJuzSet));
                };
                
                juzCheckboxes.appendChild(label);
            }
        }
        
        // Clear all Juz selections
        function clearJuzSelection() {
            selectedJuzSet.clear();
            const checkboxes = document.querySelectorAll('.juz-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.classList.remove('active');
            });
            
            // Update available Surahs
            updateAvailableSurahs();
            
            // Hide the surah list if it's visible
            surahList.style.display = 'none';
        }
        
        // Show Surahs in the selected Juz
        function showSurahsInSelectedJuz() {
            // Check if any Juz is selected
            if (selectedJuzSet.size === 0) {
                alert('Please select at least one Juz to see the Surahs in it.');
                return;
            }
            
            // Clear previous Surah chips
            surahChips.innerHTML = '';
            
            // Create a set to store all unique Surahs across selected Juz
            const uniqueSurahs = new Set();
            
            // Debug: Log selected Juz and their maps
            console.log("Selected Juz:", Array.from(selectedJuzSet));
            console.log("Juz to Surah Map:", juzToSurahMap);
            
            // Add all Surahs from each selected Juz
            selectedJuzSet.forEach(juz => {
                const juzNumber = parseInt(juz);
                console.log(`Processing Juz ${juzNumber}...`);
                
                if (juzToSurahMap[juzNumber]) {
                    console.log(`  Juz ${juzNumber} has ${juzToSurahMap[juzNumber].size} Surahs`);
                    juzToSurahMap[juzNumber].forEach(surahIndex => {
                        uniqueSurahs.add(parseInt(surahIndex));
                    });
                } else {
                    console.error(`  No Surah map found for Juz ${juzNumber}!`);
                }
            });
            
            // Sort the Surahs by their number
            const sortedSurahs = Array.from(uniqueSurahs).sort((a, b) => a - b);
            console.log("Sorted Surahs indices:", sortedSurahs);
            
            // Create chips for each Surah
            sortedSurahs.forEach(surahIndex => {
                const surah = quranData[surahIndex];
                console.log(`Processing Surah index ${surahIndex}:`, surah);
                
                if (!surah) {
                    console.error(`No Surah found at index ${surahIndex}!`);
                    return; // Skip this iteration
                }
                
                const chip = document.createElement('div');
                chip.className = 'surah-chip';
                
                // Safely access properties with fallbacks
                const surahNumber = surah.number || surahIndex + 1;
                const surahName = surah.englishName || surah.name || `Surah ${surahIndex + 1}`;
                
                chip.textContent = `${surahNumber}. ${surahName}`;
                surahChips.appendChild(chip);
            });
            
            // Show the surah list
            surahList.style.display = 'block';
        }
        
        // Update the available Surahs based on selected Juz
        function updateAvailableSurahs() {
            // Reset available Surahs
            availableSurahs = new Set();
            
            // Debug: Log the selection state
            console.log("Updating available Surahs for selection:", Array.from(selectedJuzSet));
            
            // Get all Surahs from selected Juz
            selectedJuzSet.forEach(juz => {
                const juzNumber = parseInt(juz);
                console.log(`Processing selected Juz ${juzNumber}...`);
                
                if (juzToSurahMap[juzNumber] && juzToSurahMap[juzNumber].size > 0) {
                    console.log(`  Found ${juzToSurahMap[juzNumber].size} Surahs in Juz ${juzNumber}`);
                    juzToSurahMap[juzNumber].forEach(surahIndex => {
                        console.log(`  Adding Surah index ${surahIndex} (${quranData[surahIndex].englishName}) to available Surahs`);
                        availableSurahs.add(parseInt(surahIndex));
                    });
                } else {
                    console.error(`  No Surahs found in Juz ${juzNumber} or juzToSurahMap is not properly initialized!`);
                }
            });
            
            console.log(`Total unique Surahs across selected Juz: ${availableSurahs.size}`);
            
            if (availableSurahs.size > 0) {
                // Log the first few Surahs for verification
                const sampleSurahs = Array.from(availableSurahs).slice(0, 5).map(idx => {
                    return `${quranData[idx].number}: ${quranData[idx].englishName}`;
                });
                console.log(`Sample Surahs: ${sampleSurahs.join(', ')}`);
            }
            
            // Update UI state
            if (selectedJuzSet.size === 0) {
                surahInfo.textContent = "Please select at least one Juz to generate random verses.";
            } else {
                const juzText = selectedJuzSet.size === 1 ? 'selected Juz' : 'selected Juz sections';
                surahInfo.textContent = `${availableSurahs.size} Surahs available across ${juzText}. Verses will be randomly selected from all of these Surahs.`;
            }
        }
        
        // Generate random ayat based on filters
        function generateRandomAyat() {
            let possibleVerses = [];
            
            // Log current selections for debugging
            console.log('Generating with:', { 
                selectedJuzSet: Array.from(selectedJuzSet)
            });
            
            // Check if any Juz is selected
            if (selectedJuzSet.size === 0) {
                arabicText.textContent = 'Please select at least one Juz';
                translation.textContent = 'Use the Juz selector above to choose which section(s) of the Quran to draw verses from';
                reference.textContent = '';
                return;
            }
            
            // Get random Ayat from all Surahs in selected Juz
            selectedJuzSet.forEach(juz => {
                const juzNumber = parseInt(juz);
                if (juzData[juzNumber] && juzData[juzNumber].length > 0) {
                    possibleVerses = possibleVerses.concat(juzData[juzNumber]);
                }
            });
            
            // Check if we have possible verses
            if (possibleVerses.length === 0) {
                arabicText.textContent = 'No verses match the selected filters';
                translation.textContent = 'Please adjust your filters and try again';
                reference.textContent = '';
                return;
            }
            
            // Select random verse from possible verses
            const randomIndex = Math.floor(Math.random() * possibleVerses.length);
            const selectedVerse = possibleVerses[randomIndex];
            
            // Get verse data
            const surah = quranData[selectedVerse.surahIndex];
            const verse = surah.verses[selectedVerse.verseIndex];
            
            // Update UI
            arabicText.textContent = verse.text;
            translation.textContent = verse.translation;
            reference.textContent = `Surah ${surah.name} (${surah.englishName}), Verse ${selectedVerse.verseIndex + 1}`;
        }
    </script>
</body>
</html> 