<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Round 1 - Itqan Quran Quiz</title>
    
    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
    <link rel="manifest" href="/assets/img/favicons/site.webmanifest">
    <meta name="msapplication-TileColor" content="#c2272b">
    <meta name="theme-color" content="#ffffff">

    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #c2272b;
            --secondary: #3475af;
            --dark: #333;
            --light: #f8f8f8;
            --gradient: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--light);
            color: var(--dark);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline-block;
        }

        .description {
            font-size: 1.1rem;
            color: #555;
            margin-bottom: 1.5rem;
        }

        .btn {
            display: inline-block;
            background: var(--gradient);
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-container {
            text-align: center;
            margin: 2rem 0;
        }

        .loading {
            text-align: center;
            font-size: 1.2rem;
            color: #777;
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .juz-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .juz-checkbox {
            display: inline-flex;
            align-items: center;
            background: #f1f1f1;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            margin-bottom: 5px;
        }

        .juz-checkbox.active {
            background: var(--primary);
            color: white;
            font-weight: 500;
        }

        .juz-checkbox input {
            display: none;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .question-container {
            display: none;
            margin-top: 2rem;
        }

        .question-container.active {
            display: block;
        }

        .question-card {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .question-content {
            margin-bottom: 1.5rem;
        }

        .arabic-text {
            font-family: 'Amiri', serif;
            font-size: 2rem;
            margin-bottom: 1rem;
            line-height: 1.7;
            text-align: right;
            direction: rtl;
        }

        .ayah-end {
            display: inline-block;
            color: var(--primary);
            font-size: 2.2rem;
            margin: 0 0.3rem;
            vertical-align: middle;
            position: relative;
            font-family: 'Amiri', serif;
        }

        .ayah-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.9rem;
            font-family: 'Amiri', serif;
            font-weight: 500;
            color: var(--dark);
        }

        .translation {
            display: none;
        }

        .answer-container {
            margin-top: 2rem;
            display: none;
            border-top: 1px solid #eee;
            padding-top: 2rem;
        }

        .answer-container.visible {
            display: block;
        }

        .answer-heading {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .next-ayahs {
            background: rgba(194, 39, 43, 0.05);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .reference {
            font-size: 1rem;
            text-align: right;
            color: var(--secondary);
            font-weight: 500;
            margin-top: 1rem;
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }

        .back-button {
            display: inline-block;
            background: #f1f1f1;
            color: #555;
            border: none;
            padding: 0.6rem 1.5rem;
            font-size: 1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .back-button:hover {
            background: #e5e5e5;
        }

        footer {
            text-align: center;
            margin-top: 3rem;
            color: #777;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .arabic-text {
                font-size: 1.5rem;
            }
            
            .translation {
                font-size: 1rem;
            }
            
            .juz-checkboxes {
                max-height: 200px;
                overflow-y: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Round 1: Quran Recitation</h1>
            <p class="description">Select Juz section(s) and test your ability to continue reciting verses from memory.</p>
        </header>

        <div class="card">
            <h2>1. Select Juz Section(s)</h2>
            <p>Choose one or more Juz sections to generate questions from. If no Juz is selected, questions will be generated from the entire Quran.</p>
            
            <div class="filters">
                <div class="filter-group">
                    <label>Juz (Section) - Select Multiple</label>
                    <div class="juz-checkboxes" id="juz-checkboxes">
                        <!-- Juz checkboxes will be added by JavaScript -->
                    </div>
                    <div style="margin-top: 10px;">
                        <button id="clear-juz" class="btn" style="padding: 0.3rem 0.8rem; font-size: 0.9rem;">Clear All</button>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9rem; color: #555;" id="selection-info">
                        No Juz selected. Questions will be generated from the entire Quran.
                    </div>
                </div>
            </div>
        </div>

        <div class="btn-container">
            <button id="generate-question-btn" class="btn">Generate Question</button>
        </div>

        <div id="question-container" class="question-container">
            <div class="question-card">
                <h2>Recitation Challenge</h2>
                <div class="question-content">
                    <p id="question-type">Continue the recitation from this verse:</p>
                    <p id="arabic-text" class="arabic-text"></p>
                    <p id="translation" class="translation"></p>
                    <p id="question-reference" class="reference"></p>
                </div>
                
                <div class="btn-container" style="margin-top: 1.5rem;">
                    <button id="show-answer-btn" class="btn">Show Answer</button>
                </div>
                
                <div id="answer-container" class="answer-container">
                    <h3 class="answer-heading">The Next Verses (Answer):</h3>
                    <div id="next-ayahs" class="next-ayahs">
                        <!-- Next ayahs will be added by JavaScript -->
                    </div>
                    <p id="answer-reference" class="reference"></p>
                </div>
            </div>
            
            <div class="btn-container">
                <button id="new-question-btn" class="btn">Generate New Question</button>
            </div>
        </div>

        <div class="nav-buttons">
            <a href="index.html" class="back-button">← Back to Quiz Rounds</a>
        </div>

        <div id="loading" class="loading">Loading Quran data...</div>

        <footer>
            <p>This quiz is designed for educational purposes. Please approach with respect for the Quranic text.</p>
        </footer>
    </div>

    <script>
        // Global variables
        let quranData = [];
        let juzData = {};
        let selectedJuzSet = new Set(); // Using a Set to store multiple selected Juz
        let juzToSurahMap = {}; // Mapping of which Surahs appear in each Juz
        let availableSurahs = new Set(); // Surahs available from selected Juz
        let currentQuestion = null; // Current question data
        
        // DOM elements
        const loading = document.getElementById('loading');
        const juzCheckboxes = document.getElementById('juz-checkboxes');
        const clearJuzBtn = document.getElementById('clear-juz');
        const selectionInfo = document.getElementById('selection-info');
        const generateQuestionBtn = document.getElementById('generate-question-btn');
        const questionContainer = document.getElementById('question-container');
        const questionType = document.getElementById('question-type');
        const arabicText = document.getElementById('arabic-text');
        const translation = document.getElementById('translation');
        const questionReference = document.getElementById('question-reference');
        const showAnswerBtn = document.getElementById('show-answer-btn');
        const answerContainer = document.getElementById('answer-container');
        const nextAyahs = document.getElementById('next-ayahs');
        const answerReference = document.getElementById('answer-reference');
        const newQuestionBtn = document.getElementById('new-question-btn');
        
        // Event listeners
        window.addEventListener('DOMContentLoaded', initializeApp);
        clearJuzBtn.addEventListener('click', clearJuzSelection);
        generateQuestionBtn.addEventListener('click', generateQuestion);
        showAnswerBtn.addEventListener('click', showAnswer);
        newQuestionBtn.addEventListener('click', generateQuestion);
        
        // Initialize the app
        async function initializeApp() {
            try {
                // Fetch Quran data
                const response = await fetch('/assets/data/quran/quran.json');
                quranData = await response.json();
                
                // Check if quranData loaded properly
                if (!quranData || !Array.isArray(quranData) || quranData.length === 0) {
                    throw new Error('Quran data not loaded properly');
                }
                
                console.log(`Quran data loaded successfully with ${quranData.length} surahs`);
                
                // Create Juz data (approximate mapping)
                createJuzData();
                
                // Populate Juz checkboxes
                populateJuzCheckboxes();
                
                // Hide loading message
                loading.style.display = 'none';
                
            } catch (error) {
                console.error('Error initializing app:', error);
                loading.textContent = 'Error loading Quran data. Please try refreshing the page.';
            }
        }
        
        // Create a mapping of Juz to Surahs and verses (approximate)
        function createJuzData() {
            console.log("Starting to create Juz to Surah mapping...");
            
            // Clear any existing data
            for (let i = 1; i <= 30; i++) {
                juzData[i] = [];
                juzToSurahMap[i] = new Set();
            }
            
            // Debug: Log the structure of the first Surah to understand the data format
            console.log("First Surah structure:", JSON.stringify(quranData[0], null, 2).substring(0, 500) + "...");
            console.log("Surah count:", quranData.length);
            
            // Helper function to get Surah number safely
            function getSurahNumber(surah) {
                if (!surah) return null;
                // Try to get number from either id or number property
                if (surah.id !== undefined) return parseInt(surah.id);
                if (surah.number !== undefined) return parseInt(surah.number);
                return null;
            }
            
            // This is an approximate mapping of Juz divisions
            const juzBoundaries = [
                { juz: 1, startSurah: 1, startVerse: 1, endSurah: 2, endVerse: 141 },
                { juz: 2, startSurah: 2, startVerse: 142, endSurah: 2, endVerse: 252 },
                { juz: 3, startSurah: 2, startVerse: 253, endSurah: 3, endVerse: 91 },
                { juz: 4, startSurah: 3, startVerse: 92, endSurah: 4, endVerse: 23 },
                { juz: 5, startSurah: 4, startVerse: 24, endSurah: 4, endVerse: 147 },
                { juz: 6, startSurah: 4, startVerse: 148, endSurah: 5, endVerse: 81 },
                { juz: 7, startSurah: 5, startVerse: 82, endSurah: 6, endVerse: 110 },
                { juz: 8, startSurah: 6, startVerse: 111, endSurah: 7, endVerse: 87 },
                { juz: 9, startSurah: 7, startVerse: 88, endSurah: 8, endVerse: 40 },
                { juz: 10, startSurah: 8, startVerse: 41, endSurah: 9, endVerse: 92 },
                { juz: 11, startSurah: 9, startVerse: 93, endSurah: 11, endVerse: 5 },
                { juz: 12, startSurah: 11, startVerse: 6, endSurah: 12, endVerse: 52 },
                { juz: 13, startSurah: 12, startVerse: 53, endSurah: 14, endVerse: 52 },
                { juz: 14, startSurah: 15, startVerse: 1, endSurah: 16, endVerse: 128 },
                { juz: 15, startSurah: 17, startVerse: 1, endSurah: 18, endVerse: 74 },
                { juz: 16, startSurah: 18, startVerse: 75, endSurah: 20, endVerse: 135 },
                { juz: 17, startSurah: 21, startVerse: 1, endSurah: 22, endVerse: 78 },
                { juz: 18, startSurah: 23, startVerse: 1, endSurah: 25, endVerse: 20 },
                { juz: 19, startSurah: 25, startVerse: 21, endSurah: 27, endVerse: 55 },
                { juz: 20, startSurah: 27, startVerse: 56, endSurah: 29, endVerse: 45 },
                { juz: 21, startSurah: 29, startVerse: 46, endSurah: 33, endVerse: 30 },
                { juz: 22, startSurah: 33, startVerse: 31, endSurah: 36, endVerse: 27 },
                { juz: 23, startSurah: 36, startVerse: 28, endSurah: 39, endVerse: 31 },
                { juz: 24, startSurah: 39, startVerse: 32, endSurah: 41, endVerse: 46 },
                { juz: 25, startSurah: 41, startVerse: 47, endSurah: 45, endVerse: 37 },
                { juz: 26, startSurah: 46, startVerse: 1, endSurah: 51, endVerse: 30 },
                { juz: 27, startSurah: 51, startVerse: 31, endSurah: 57, endVerse: 29 },
                { juz: 28, startSurah: 58, startVerse: 1, endSurah: 66, endVerse: 12 },
                { juz: 29, startSurah: 67, startVerse: 1, endSurah: 77, endVerse: 50 },
                { juz: 30, startSurah: 78, startVerse: 1, endSurah: 114, endVerse: 6 }
            ];
            
            console.log("Processing each Juz with explicit boundaries...");
            
            // Process each Juz with its boundaries
            juzBoundaries.forEach(boundary => {
                const juzNum = boundary.juz;
                const startSurahNum = boundary.startSurah;
                const startVerseNum = boundary.startVerse;
                const endSurahNum = boundary.endSurah;
                const endVerseNum = boundary.endVerse;
                
                console.log(`Processing Juz ${juzNum}: Surah ${startSurahNum}:${startVerseNum} to Surah ${endSurahNum}:${endVerseNum}`);
                
                // Find all Surahs in this range
                for (let surahIdx = 0; surahIdx < quranData.length; surahIdx++) {
                    const surah = quranData[surahIdx];
                    
                    // Check if surah has the expected properties
                    if (!surah) {
                        console.error(`Invalid surah at index ${surahIdx}: null or undefined`);
                        continue;
                    }
                    
                    // Get the Surah number (1-indexed)
                    const surahNum = getSurahNumber(surah);
                    if (surahNum === null) {
                        console.error(`Cannot determine surah number at index ${surahIdx}:`, surah);
                        continue;
                    }
                    
                    // Skip Surahs outside the range for this Juz
                    if (surahNum < startSurahNum || surahNum > endSurahNum) {
                        continue;
                    }
                    
                    // Keep track if any verses from this Surah are in this Juz
                    let hasVersesInJuz = false;
                    
                    // Check all verses in this Surah
                    if (!surah.verses || !Array.isArray(surah.verses)) {
                        console.error(`No verses array for surah ${surahNum} at index ${surahIdx}`);
                        continue;
                    }
                    
                    for (let verseIdx = 0; verseIdx < surah.verses.length; verseIdx++) {
                        const verseNum = verseIdx + 1; // 1-indexed verse number
                        
                        // Skip verses before the start verse in the starting Surah
                        if (surahNum === startSurahNum && verseNum < startVerseNum) {
                            continue;
                        }
                        
                        // Skip verses after the end verse in the ending Surah
                        if (surahNum === endSurahNum && verseNum > endVerseNum) {
                            continue;
                        }
                        
                        // This verse is in this Juz - add it to the data
                        juzData[juzNum].push({
                            surahIndex: surahIdx,
                            verseIndex: verseIdx
                        });
                        
                        hasVersesInJuz = true;
                    }
                    
                    // If this Surah has at least one verse in this Juz, add it to the map
                    if (hasVersesInJuz) {
                        juzToSurahMap[juzNum].add(surahIdx);
                        const englishName = surah.englishName || surah.translation || `Surah ${surahNum}`;
                        const arabicName = surah.name || `سورة ${surahNum}`;
                        console.log(`  Added Surah ${surahNum} (${englishName}) to Juz ${juzNum}`);
                    }
                }
                
                console.log(`Juz ${juzNum} contains ${juzToSurahMap[juzNum].size} Surahs and ${juzData[juzNum].length} verses`);
            });
            
            // Special handling for Juz 30 (Surahs 78-114)
            console.log("Ensuring Juz 30 has the correct Surahs (78-114)...");
            
            // Clear existing data for Juz 30 to ensure clean mapping
            juzData[30] = [];
            juzToSurahMap[30] = new Set();
            
            // Log all available Surah numbers for debugging
            const availableSurahs = quranData.map(s => getSurahNumber(s)).filter(n => n !== null).sort((a, b) => a - b);
            console.log("Available Surah numbers:", availableSurahs);
            
            // Directly map Surahs 78-114 to Juz 30
            for (let surahIdx = 0; surahIdx < quranData.length; surahIdx++) {
                const surah = quranData[surahIdx];
                
                // Skip invalid Surahs
                if (!surah) {
                    continue;
                }
                
                const surahNum = getSurahNumber(surah);
                
                // Skip if not a valid number
                if (surahNum === null) {
                    continue;
                }
                
                if (surahNum >= 78 && surahNum <= 114) {
                    const englishName = surah.englishName || surah.translation || `Surah ${surahNum}`;
                    const arabicName = surah.name || `سورة ${surahNum}`;
                    console.log(`Directly adding Surah ${surahNum} (${englishName}) to Juz 30`);
                    
                    // Add all verses from this Surah to Juz 30
                    if (surah.verses && Array.isArray(surah.verses)) {
                        for (let verseIdx = 0; verseIdx < surah.verses.length; verseIdx++) {
                            juzData[30].push({
                                surahIndex: surahIdx,
                                verseIndex: verseIdx
                            });
                        }
                        
                        // Add this Surah to the Juz 30 map
                        juzToSurahMap[30].add(surahIdx);
                    } else {
                        console.error(`No verses array for Surah ${surahNum} at index ${surahIdx}`);
                    }
                }
            }
            
            console.log(`After direct mapping, Juz 30 contains ${juzToSurahMap[30].size} Surahs and ${juzData[30].length} verses`);
            
            // Verify Juz data
            for (let juz = 1; juz <= 30; juz++) {
                if (juzData[juz].length === 0) {
                    console.error(`ERROR: Juz ${juz} has no verses!`);
                } else {
                    console.log(`Verified: Juz ${juz} has ${juzData[juz].length} verses and ${juzToSurahMap[juz].size} Surahs`);
                    
                    // Log some sample Surahs in this Juz
                    const sampleSurahs = Array.from(juzToSurahMap[juz]).slice(0, 5);
                    if (sampleSurahs.length > 0) {
                        console.log(`Sample Surahs in Juz ${juz}:`, sampleSurahs.map(idx => {
                            const surah = quranData[idx];
                            if (!surah) return `Invalid surah at index ${idx}`;
                            
                            const surahNum = getSurahNumber(surah);
                            const englishName = surah.englishName || surah.translation || `Surah ${surahNum}`;
                            return `${surahNum}: ${englishName}`;
                        }));
                    }
                }
            }
        }
        
        // Populate Juz checkboxes
        function populateJuzCheckboxes() {
            juzCheckboxes.innerHTML = ''; // Clear existing checkboxes first
            
            for (let i = 1; i <= 30; i++) {
                const label = document.createElement('label');
                label.className = 'juz-checkbox';
                label.dataset.juz = i;
                
                // Create checkbox
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = i;
                checkbox.style.display = 'none';
                
                // Add text node
                const text = document.createTextNode(`Juz ${i}`);
                
                // Append checkbox and text to label
                label.appendChild(checkbox);
                label.appendChild(text);
                
                // Add event listener to toggle selection
                label.onclick = function(event) {
                    event.preventDefault(); // Prevent default checkbox behavior
                    const juz = parseInt(this.dataset.juz);
                    
                    if (selectedJuzSet.has(juz)) {
                        selectedJuzSet.delete(juz);
                        this.classList.remove('active');
                        checkbox.checked = false;
                    } else {
                        selectedJuzSet.add(juz);
                        this.classList.add('active');
                        checkbox.checked = true;
                    }
                    
                    // Update selection info
                    updateSelectionInfo();
                    
                    // Log selection for debugging
                    console.log('Selected Juz:', Array.from(selectedJuzSet));
                };
                
                juzCheckboxes.appendChild(label);
            }
        }
        
        // Update selection info
        function updateSelectionInfo() {
            if (selectedJuzSet.size === 0) {
                selectionInfo.textContent = "No Juz selected. Questions will be generated from the entire Quran.";
            } else {
                const juzText = selectedJuzSet.size === 1 ? 'Juz' : 'Juz sections';
                selectionInfo.textContent = `${selectedJuzSet.size} ${juzText} selected. Questions will be generated from these sections only.`;
            }
        }
        
        // Clear all Juz selections
        function clearJuzSelection() {
            selectedJuzSet.clear();
            const checkboxes = document.querySelectorAll('.juz-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.classList.remove('active');
            });
            
            // Update selection info
            updateSelectionInfo();
        }
        
        // Generate a question based on selected Juz
        function generateQuestion() {
            // Reset previous question
            resetQuestion();
            
            // Determine the verses to use based on Juz selection
            let possibleVerses = [];
            
            if (selectedJuzSet.size === 0) {
                // No Juz selected, use all Surahs
                console.log("No Juz selected, using all Surahs");
                for (let surahIdx = 0; surahIdx < quranData.length; surahIdx++) {
                    const surah = quranData[surahIdx];
                    if (!surah || !surah.verses || !Array.isArray(surah.verses)) {
                        continue;
                    }
                    
                    // Only include verses that have at least 5 following verses in the same Surah
                    for (let verseIdx = 0; verseIdx < surah.verses.length - 5; verseIdx++) {
                        possibleVerses.push({
                            surahIndex: surahIdx,
                            verseIndex: verseIdx
                        });
                    }
                }
            } else {
                // Use selected Juz
                console.log("Using selected Juz:", Array.from(selectedJuzSet));
                selectedJuzSet.forEach(juz => {
                    const juzNumber = parseInt(juz);
                    console.log(`Processing Juz ${juzNumber} for question generation`);
                    
                    if (juzData[juzNumber] && juzData[juzNumber].length > 0) {
                        console.log(`Juz ${juzNumber} has ${juzData[juzNumber].length} verses and ${juzToSurahMap[juzNumber].size} Surahs`);
                        
                        // Debug: Log some sample Surahs in this Juz
                        const sampleSurahs = Array.from(juzToSurahMap[juzNumber]).slice(0, 5);
                        if (sampleSurahs.length > 0) {
                            console.log(`Sample Surahs in Juz ${juzNumber}:`, sampleSurahs.map(idx => {
                                const surah = quranData[idx];
                                if (!surah) return `Invalid surah at index ${idx}`;
                                
                                // Helper function to get Surah number safely
                                function getSurahNumber(surah) {
                                    if (!surah) return null;
                                    // Try to get number from either id or number property
                                    if (surah.id !== undefined) return parseInt(surah.id);
                                    if (surah.number !== undefined) return parseInt(surah.number);
                                    return null;
                                }
                                
                                const surahNum = getSurahNumber(surah);
                                const englishName = surah.englishName || surah.translation || `Surah ${surahNum}`;
                                return `${surahNum}: ${englishName}`;
                            }));
                        }
                        
                        // For each verse in this Juz, check if it has enough following verses
                        juzData[juzNumber].forEach(verse => {
                            const surah = quranData[verse.surahIndex];
                            if (!surah || !surah.verses || !Array.isArray(surah.verses)) {
                                return;
                            }
                            
                            // Only include if the verse has at least 5 following verses in the same Surah
                            if (verse.verseIndex <= surah.verses.length - 6) {
                                possibleVerses.push(verse);
                                
                                // Debug logging
                                if (possibleVerses.length % 50 === 0) {
                                    console.log(`Added ${possibleVerses.length} possible verses so far`);
                                }
                            }
                        });
                    } else {
                        console.error(`Juz ${juzNumber} has no verses or is not properly initialized!`);
                        console.log(`juzData[${juzNumber}] =`, juzData[juzNumber]);
                        console.log(`juzToSurahMap[${juzNumber}] =`, juzToSurahMap[juzNumber]);
                    }
                });
            }
            
            // Debug: Log the number of possible verses
            console.log(`Total possible verses for question: ${possibleVerses.length}`);
            
            // Check if we have possible verses
            if (possibleVerses.length === 0) {
                alert('No suitable verses available for the selected filters. Please adjust your selection.');
                return;
            }
            
            // Select random verse for the question
            const randomIndex = Math.floor(Math.random() * possibleVerses.length);
            const selectedVerse = possibleVerses[randomIndex];
            
            // Get the Surah for the selected verse
            const surah = quranData[selectedVerse.surahIndex];
            if (!surah) {
                console.error(`Invalid surah at index ${selectedVerse.surahIndex}`);
                alert('Error generating question. Please try again.');
                return;
            }
            
            // Helper function to get Surah number safely
            function getSurahNumber(surah) {
                if (!surah) return null;
                // Try to get number from either id or number property
                if (surah.id !== undefined) return parseInt(surah.id);
                if (surah.number !== undefined) return parseInt(surah.number);
                return null;
            }
            
            // Debug: Log the selected verse
            const surahNum = getSurahNumber(surah);
            console.log(`Selected verse: Surah ${surahNum}, Verse ${selectedVerse.verseIndex + 1}`);
            
            // Store current question
            currentQuestion = selectedVerse;
            
            // Get verse data
            const verse = surah.verses[selectedVerse.verseIndex];
            if (!verse) {
                console.error(`Invalid verse at index ${selectedVerse.verseIndex} in surah ${surahNum}`);
                alert('Error generating question. Please try again.');
                return;
            }
            
            // Update question content
            arabicText.textContent = verse.text;
            
            // Add ayah end marker with verse number
            arabicText.innerHTML = arabicText.textContent + ' <span class="ayah-end">۝<span class="ayah-number">' + convertToArabicNumerals(selectedVerse.verseIndex + 1) + '</span></span>';
            
            // Fix for undefined Surah name - ensure we have both Arabic and English names
            const surahName = surah.name || `سورة ${surahNum}`;
            const englishName = surah.englishName || surah.translation || `Surah ${surahNum}`;
            questionReference.textContent = `Surah ${surahName} (${englishName}), Verse ${selectedVerse.verseIndex + 1}`;
            
            // Show the question container
            questionContainer.classList.add('active');
        }
        
        // Show the answer (next 4-5 ayahs)
        function showAnswer() {
            // Make sure we have a current question
            if (!currentQuestion) return;
            
            // Clear previous answer content
            nextAyahs.innerHTML = '';
            
            // Get the Surah and starting verse
            const surahIndex = currentQuestion.surahIndex;
            const verseIndex = currentQuestion.verseIndex;
            const surah = quranData[surahIndex];
            
            // Helper function to get Surah number safely
            function getSurahNumber(surah) {
                if (!surah) return null;
                // Try to get number from either id or number property
                if (surah.id !== undefined) return parseInt(surah.id);
                if (surah.number !== undefined) return parseInt(surah.number);
                return null;
            }
            
            // Determine how many verses to show (usually 5, but might be fewer if near end of Surah)
            const verseCount = Math.min(5, surah.verses.length - (verseIndex + 1));
            
            // Create DOM elements for next ayahs
            for (let i = 1; i <= verseCount; i++) {
                const nextVerseIndex = verseIndex + i;
                const nextVerse = surah.verses[nextVerseIndex];
                
                // Create container for this verse
                const verseContainer = document.createElement('div');
                verseContainer.style.marginBottom = '1.5rem';
                
                // Create Arabic text
                const arabicText = document.createElement('p');
                arabicText.className = 'arabic-text';
                arabicText.style.marginBottom = '0.5rem';
                arabicText.innerHTML = nextVerse.text + ' <span class="ayah-end">۝<span class="ayah-number">' + convertToArabicNumerals(nextVerseIndex + 1) + '</span></span>';
                
                // Add elements to verse container
                verseContainer.appendChild(arabicText);
                
                // Add verse container to nextAyahs
                nextAyahs.appendChild(verseContainer);
            }
            
            // Fix for undefined Surah name in answer reference
            const surahNum = getSurahNumber(surah);
            const surahName = surah.name || `سورة ${surahNum}`;
            const englishName = surah.englishName || surah.translation || `Surah ${surahNum}`;
            answerReference.textContent = `Surah ${surahName} (${englishName}), Verses ${verseIndex + 2} to ${verseIndex + 1 + verseCount}`;
            
            // Show the answer container
            answerContainer.classList.add('visible');
            
            // Hide the show answer button
            showAnswerBtn.style.display = 'none';
        }
        
        // Reset the question state for a new question
        function resetQuestion() {
            // Clear the content
            arabicText.textContent = '';
            questionReference.textContent = '';
            nextAyahs.innerHTML = '';
            answerReference.textContent = '';
            
            // Reset the container visibility
            answerContainer.classList.remove('visible');
            
            // Show the show answer button
            showAnswerBtn.style.display = 'inline-block';
            
            // Reset current question
            currentQuestion = null;
        }

        // Helper function to convert numbers to Arabic numerals
        function convertToArabicNumerals(num) {
            const arabicNumerals = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
            return num.toString().split('').map(digit => arabicNumerals[parseInt(digit)]).join('');
        }
    </script>
</body>
</html> 